<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Smak</title>
        <link rel="stylesheet" href="chessboardjs/css/chessboard-1.0.0.min.css">
    </head>
    <body>
        <div>
            <div style="float: left; width: 30%; position: relative; left: 30%;">
                <div id="myBoard" style="width: 100%;"></div>
                <div id="btns" style="width: 100%;">
                    <button id="prevbtn" style="width: 25%; padding-right: 0; margin-right: 0%;">Previous move</button>
                    <button id="nextbtn" style="width: 24.5%; padding-left: 0; margin-left: 0%; padding-right: 0% ; margin-right: 0%;">Next move</button>
                    <button id="resetbtn" style="width: 25%; padding-left: 0; padding-right: 0%; margin-left: 24%;">Reset position</button>
                </div>
                <table id="evaltable" style="margin-top: 2em; position: relative; table-layout: fixed;">
                    <thead>
                        <tr>
                            <th scope="col">Ply</th>
                            <th scope="col">Evaluation</th>
                            <th scope="col">Best move</th>
                            <th scope="col">Best response</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="plycol">0</td>
                            <td id="evcol"></td>
                            <td id="bmcol"></td>
                            <td id="pdcol"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="float: right; position: relative; right: 29%; height: 30%; margin-left: 1em; padding-left: 1em;">
                <div class="movescontainer">
                    <table class="mtable" id="movestable" style="position: relative; width: 12em; table-layout: fixed;">
                        <thead style="width: 5em;">
                            <th scope="col" style="max-width: 1em;">#</th>
                            <th scope="col" style="background-color: white; max-width: min-content;"></th>
                            <th scope="col" style="background-color: black; max-width: min-content;"></th>
                        </thead>
                        <tbody>

                        </tbody>
                    </table>
                </div>

                <form id="gameform" style="width:auto; ">
                    <div>
                        <input id="gameidinput" type="number" min="0" style="max-width: 5em; margin-top: 1em;" placeholder="Input game ID here"/>
                    </div>
                    <div style="position: relative; left: 0em">
                        <input type="submit" width="10em" style="text-align: center;" value="Select ID">
                    </div>                    
                </form>
            </div>
        </div>
    </div>

    <style>th, td {border: 1px solid black; padding: 8px 10px;}; </style>
    <style>
        table {
            border-collapse: collapse; 
            border: 2px solid black;
        }
    </style>
    <style>
        .movescontainer {
            border: 1px solid black padding 8px 10px;
            border-bottom: none;
            overflow: auto;
            height: 30%;
        }
        .mtable {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }
        .mtable td:empty {
            border-left: 0;
            border-right: 0;
        }
        .mtable th:nth-child(1) {
            position: sticky;
            left: 0;
        }

        .mtable th,
        .mtable td {
            text-align: center;
            padding: 0;
        }

        .no-data {
            text-align: center;
        }

        .clickable {
            text-align: center;
            font-size: medium;
            display: block;
            width: 100%;
            height: 100%;
            outline: 0; 
            background-color: transparent; 
            border: none;
        }
    </style>

        
    <script src="node_modules/jquery/dist/jquery.min.js"></script>
    <script src="geteval.js"></script>
    <script src="chessboardjs/js/chessboard-1.0.0.js"></script>
    <script>
        var ply_counter = document.getElementById("plycol");
        var board = Chessboard('myBoard', 'start');
        var index = 0;
        var positions = [];
        $('#nextbtn').on('click', function() {
            if (move_array.length === 0) {
                return;
            }
            if (index >= move_array.length) {
                return;
            }
            if(!(positions.length > index)) {
                positions.push(board.fen())
            }
            
            board.move(move_array[index]);
            index++;
            ply_counter.innerHTML = (index).toString();
            updateEvalTbl(index);
            colorMoveTable(index);
        })

        $('#prevbtn').on('click', function() {            
            if (move_array.length === 0) {
                return;
            }
            if (index <= 1) {
                //colorMoveTable(index);
                clearEvalTbl();
                ply_counter.innerHTML = "0";
                board.start();
                if (index <= 0) {
                    return;
                }
            }
            index--
            if (index > 0) {
                colorMoveTable(index);
            } else {
                movestable.rows.item(1).cells.item(1).style.backgroundColor = "White";
            }
            ply_counter.innerHTML = index.toString();
            //board.move(fools_mate[index])
            board.position(positions[index]);
            updateEvalTbl(index);
        })

        $('#resetbtn').on('click', function() {
            positions = [];
            evals = [];
            move_array = [];
            index = 0;
            ply_counter.innerHTML = "0";
            board.start();
            deleteMoves();
            clearEvalTbl();
        });

        $('form').on('submit', function(event) {
            event.preventDefault();
            positions = [];
            evals = [];
            index = 0;
            ply_counter.innerHTML = "0";
            board.start();
            deleteMoves();
            clearEvalTbl();
            var formid = $("#gameidinput").first().val();
            const id = Number.parseInt(formid);            
            getEval(id)
        });

        $('#tblbtn').on('click', function(event) {
            event.stopPropagation();
            event.stopImmediatePropagation();
            console.log("We get here?");
            
            let m_id = (this).data("cellid");
            if (index < m_id) {
                for (let i = index; i < m_id; i++) {
                    $('#nextbtn').click();
                }
            } 
            if (index > m_id) {
                for (let i = m_id; i > m_id; i--) {
                    $('#prevbtn').click();
                }
            }
        });

        function jumpToMove(moveno) {
            console.log("jumping to move " + moveno);
            
            let m_id = moveno + 1;
            if (index < m_id) {
                for (let i = index; i < m_id; i++) {
                    $('#nextbtn').click();
                }
            } 
            if (index > m_id) {
                console.log("Reverse path");
                
                for (let i = index; i > m_id; i--) {
                    $('#prevbtn').click();
                }
            }
        }
    </script>
    </body>



</html>
