- name: TTTDeploy
  hosts: all
  become: true
  become_user: root

  vars_files:
    - ./tictactoeVault

  vars:
    # --- customize these ---
    repo_url: "https://github.com/chrnigi/P5-SMAK.git"
    repo_dest: "/opt/SMAK"          # where the repo will live
    app_subdir: "cloud/jpadb/Smak"                   # if mvnw is in a subdir, e.g. "server"; else ""
    app_dir: "{{ repo_dest }}/{{ app_subdir }}"
    screen_session: "TTT"
    # file you want to change INSIDE the repo
    file_to_modify: "{{ app_dir }}/src/main/resources/application.properties"
    phpfiletomodify: "{{ repo_dest }}/cloud/php/index.php"
    # how to start your program after mvn package
    start_command: "java -jar target/Smak-0.0.1-SNAPSHOT.jar"
    # ------------------------

  tasks:
    - name: Mark /opt/SMAK as safe git directory for root
      community.general.git_config:
        name: safe.directory
        value: "{{ repo_dest }}"
        scope: global
        state: present


    - name: Clone or update Git repository
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ repo_dest }}"
        version: main
        force: true

    - name: Ensure username correct
      ansible.builtin.lineinfile:
        path: "{{ file_to_modify }}"
        regexp: '^spring.datasource.username='
        line: 'spring.datasource.username={{ db_username }}'
        create: true
        owner: root
        group: root
        mode: "0640"

    - name: Ensure password correct
      ansible.builtin.lineinfile:
        path: "{{ file_to_modify }}"
        regexp: '^spring.datasource.password='
        line: 'spring.datasource.password={{ db_password }}'
        create: true
        owner: root
        group: root
        mode: "0640"

    - name: Ensure mvnw is executable
      ansible.builtin.file:
        path: "{{ app_dir }}/mvnw"
        mode: "0755"

    - name: Run Maven package (skip tests)
      ansible.builtin.command: ./mvnw package -Dmaven.test.skip=true
      args:
        chdir: "{{ app_dir }}"
      register: mvn_result
      changed_when: "'BUILD SUCCESS' in mvn_result.stdout"

    - name: Show Maven output (optional)
      ansible.builtin.debug:
        var: mvn_result.stdout_lines

    # Create non-root user for safety
    - name: Ensure app user exists
      ansible.builtin.user:
        name: smak
        shell: /bin/bash

    # Repo must belong to smak so the app can run correctly
    - name: Ensure repo ownership
      ansible.builtin.file:
        path: "{{ repo_dest }}"
        owner: smak
        group: smak
        recurse: true

    # Kill dead or existing screen sessions AS smak
    - name: Cleanup existing screen sessions
      ansible.builtin.shell: |
        screen -wipe || true
        screen -S {{ screen_session }} -X quit || true
      args:
        chdir: "{{ app_dir }}"
      become: true
      become_user: smak
      register: screen_cleanup
      failed_when: false
      changed_when: true


    # Start the application AS smak
    - name: Start application in detached screen session
      ansible.builtin.command: >
        screen -dmS {{ screen_session }} {{ start_command }}
      args:
        chdir: "{{ app_dir }}"
      become: true
      become_user: smak
      changed_when: true


    - name: Check screen sessions for {{ screen_session }}
      ansible.builtin.command: screen -ls
      args:
        chdir: "{{ app_dir }}"
      become: true
      become_user: smak
      register: screen_check
      failed_when: false
      changed_when: false


    - name: Decide if screen session is missing or dead
      ansible.builtin.set_fact:
        screen_session_needs_restart: >-
          {{ screen_check.rc != 0
             or (
                  (screen_check.stdout is search('\\.{{ screen_session }}'))
                  and (screen_check.stdout is search('Dead'))
                )
          }}

    - name: Restart application if screen session is missing or dead
      ansible.builtin.shell: |
        screen -wipe || true
        screen -dmS {{ screen_session }} {{ start_command }}
      args:
        chdir: "{{ app_dir }}"
      become: true
      become_user: smak
      when: screen_session_needs_restart | bool
      register: screen_restart
      changed_when: screen_restart.rc == 0


##########################
####### PHP DEPLOY #######
##########################
    - name: Ensure dbname correct
      ansible.builtin.lineinfile:
        path: "{{ phpfiletomodify }}"
        regexp: '^\$DB_NAME\s*='
        line: "$DB_NAME = '{{ db_name }}';"
        create: true
        owner: root
        group: root
        mode: "0640"

    - name: Ensure webui username correct
      ansible.builtin.lineinfile:
        path: "{{ phpfiletomodify }}"
        regexp: '^\$DB_USER\s*='
        line: "$DB_USER = '{{ webui_username }}';"
        create: true
        owner: root
        group: root
        mode: "0640"

    - name: Ensure webui password correct
      ansible.builtin.lineinfile:
        path: "{{ phpfiletomodify }}"
        regexp: '^\$DB_PASS\s*='
        line: "$DB_PASS = '{{ webui_password }}';"
        create: true
        owner: root
        group: root
        mode: "0640"


    - name: Ensure tictactoe web directory exists
      ansible.builtin.file:
        path: "/var/www/html/tictactoe"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Deploy tictactoe index.php
      ansible.builtin.copy:
        src: "{{ phpfiletomodify }}"
        dest: "/var/www/html/tictactoe/index.php"
        owner: root
        group: root
        mode: "0644"
        remote_src: true
