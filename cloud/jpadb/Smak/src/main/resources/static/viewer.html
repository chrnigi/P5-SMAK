</body>
</html>


<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Smak Chess Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root {
    --bg: #0d1117;
    --fg: #e6edf3;
    --card: #161b22;
    --border: #30363d;
    --muted: #8b949e;
    --light-square: #cfc2ad;
    --dark-square: #080808;
  }

  body {
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: system-ui, sans-serif;
  }

  header {
    padding: 12px 20px;
    background: #090d12;
    display: flex;
    align-items: center;
    gap: 14px;
    border-bottom: 1px solid var(--border);
  }

  header strong { font-size: 15px; }

  header select,
  header button {
    background: #0d1117;
    color: var(--fg);
    border-radius: 999px;
    border: 1px solid var(--border);
    padding: 4px 10px;
    font-size: 13px;
  }

  header button {
    cursor: pointer;
  }
  header button:hover { background:#111827; }

  #status {
    margin-left: auto;
    font-size: 12px;
    color: var(--muted);
  }

  main {
    display: grid;
    grid-template-columns: 520px 1fr;
    gap: 20px;
    padding: 20px;
  }

  .panel {
    padding: 14px 16px;
    border-radius: 10px;
    background: var(--card);
    border: 1px solid var(--border);
  }

  h2 { margin: 0 0 8px 0; font-size: 16px; }

  /* Visual chess board */
  #board {
    width: 100%;
    max-width: 480px;
    aspect-ratio: 1 / 1;
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    grid-auto-rows: 1fr;
    border-radius: 10px;
    overflow: hidden;
    margin: 0 auto;
  }

  .square {
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:34px;
    user-select:none;
  }
  .light { background: var(--light-square); }
  .dark  { background: var(--dark-square); }

  #gameInfo {
    margin-top: 10px;
    padding: 8px 10px;
    background: #0f141a;
    border-radius: 7px;
    border: 1px solid var(--border);
    font-family: ui-monospace, Menlo, Consolas, monospace;
    white-space: pre-line;
    font-size: 13px;
  }

  .controls {
    margin-top: 10px;
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .controls button {
    width: 32px;
    height: 32px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #0d1117;
    color: var(--fg);
    cursor: pointer;
  }
  .controls button:hover { background:#111827; }

  #plyLabel {
    margin-left: 10px;
    font-size: 13px;
    color: var(--muted);
  }

  #movesTable {
    width: 100%;
    margin-top: 6px;
    border-collapse: collapse;
    font-size: 13px;
  }
  #movesTable th, #movesTable td {
    padding: 6px 5px;
    border-bottom: 1px solid var(--border);
  }
  #movesTable th {
    text-align: left;
    font-size: 12px;
    color: var(--muted);
  }

  #movesTable tr.active { background:#1d2633; }
  #movesTable tr:hover  { background:#1b2230; cursor:pointer; }

  .flag { font-size:12px; color:#f97373; }

  @media (max-width: 900px) {
    main { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <strong>♟ Smak Viewer</strong>
  Game:
  <select id="gameSelect"></select>
  <button id="refreshBtn">↻ Refresh</button>
  <span id="status"></span>
</header>

<main>
  <!-- LEFT: board + game meta + navigation -->
  <div class="panel">
    <h2>Board</h2>
    <div id="board"></div>

    <div id="gameInfo"></div>

    <div class="controls">
      <button id="btnFirst">⏮</button>
      <button id="btnPrev">◀</button>
      <button id="btnNext">▶</button>
      <button id="btnLast">⏭</button>
      <span id="plyLabel"></span>
    </div>
  </div>

  <!-- RIGHT: move list -->
  <div class="panel">
    <h2>Moves</h2>
    <table id="movesTable">
      <thead>
      <tr><th>#</th><th>Side</th><th>Move (UCI)</th><th>Flags</th></tr>
      </thead>
      <tbody id="movesBody"></tbody>
    </table>
  </div>
</main>

<script>
  const el = {
    gameSelect: document.getElementById('gameSelect'),
    refreshBtn: document.getElementById('refreshBtn'),
    status: document.getElementById('status'),
    board: document.getElementById('board'),
    gameInfo: document.getElementById('gameInfo'),
    movesBody: document.getElementById('movesBody'),
    btnFirst: document.getElementById('btnFirst'),
    btnPrev: document.getElementById('btnPrev'),
    btnNext: document.getElementById('btnNext'),
    btnLast: document.getElementById('btnLast'),
    plyLabel: document.getElementById('plyLabel'),
  };

  // Viewer state
  const state = {
    game: null,
    moves: [],      // raw moves from backend (with uci, pieceMoved, pieceCaptured, promotion)
    boards: [],     // boards[i] = position after i moves, boards[0] = start
    index: -1       // -1 => initial position (boards[0])
  };

  async function fetchJson(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  /* Board representation from UCI  */

  // Build standard starting position, 8x8, chars: rnbqkbnr / p / P / R etc, '.' = empty
  function initialBoard() {
    const rows = [
      "rnbqkbnr",
      "pppppppp",
      "........",
      "........",
      "........",
      "........",
      "PPPPPPPP",
      "RNBQKBNR"
    ];
    return rows.map(r => r.split(""));
  }

  function cloneBoard(b) {
    return b.map(row => row.slice());
  }

  function squareFromAlgebraic(sq) {
    // sq like "e4"
    const file = sq.charCodeAt(0) - "a".charCodeAt(0); // 0..7
    const rankNum = parseInt(sq[1], 10);               // 1..8
    const rank = 8 - rankNum;                          // 0 = 8th rank (top)
    return { rank, file };
  }

  function applyUci(board, move) {
    const uci = move.uci || "";
    if (uci.length < 4) return;

    const from = squareFromAlgebraic(uci.slice(0, 2));
    const to   = squareFromAlgebraic(uci.slice(2, 4));
    const isWhite = (move.plyno % 2 === 1);

    let piece = board[from.rank][from.file];

    // If for some reason we don't find a piece, fall back to something reasonable
    if (!piece || piece === ".") {
      piece = isWhite ? "P" : "p";
    }

    // Handle castling
    const isKing = piece === "K" || piece === "k";
    if (isKing && Math.abs(from.file - to.file) === 2) {
      // King move
      board[from.rank][from.file] = ".";
      board[to.rank][to.file] = piece;

      // Rook move as part of castling
      if (to.file === 6) { // king side: e1g1 or e8g8
        const rookFromFile = 7;
        const rookToFile   = 5;
        const rook = board[from.rank][rookFromFile];
        board[from.rank][rookFromFile] = ".";
        board[from.rank][rookToFile]   = rook;
      } else if (to.file === 2) { // queen side: e1c1 or e8c8
        const rookFromFile = 0;
        const rookToFile   = 3;
        const rook = board[from.rank][rookFromFile];
        board[from.rank][rookFromFile] = ".";
        board[from.rank][rookToFile]   = rook;
      }
      return;
    }

    // Promotion: either promotion=true or uci like e7e8q
    const willPromote = move.promotion || (uci.length >= 5 && (uci[4] === "q" || uci[4] === "Q"));
    if (willPromote) {
      piece = isWhite ? "Q" : "q";
    }

    // Normal move (capture = just overwrite target square)
    board[from.rank][from.file] = ".";
    board[to.rank][to.file] = piece;
  }

  // Precompute all board positions from UCI moves
  function buildBoardsFromMoves(moves) {
    const boards = [];
    let b = initialBoard();
    boards.push(cloneBoard(b)); // after 0 moves

    const ordered = [...moves].sort((a, b) => (a.plyno ?? 0) - (b.plyno ?? 0));
    ordered.forEach(m => {
      applyUci(b, m);
      boards.push(cloneBoard(b));
    });

    return { boards, ordered };
  }

  /* ---------- rendering ---------- */

  function pieceChar(c) {
    switch (c) {
      case "P": return "♙";
      case "N": return "♘";
      case "B": return "♗";
      case "R": return "♖";
      case "Q": return "♕";
      case "K": return "♔";
      case "p": return "♟";
      case "n": return "♞";
      case "b": return "♝";
      case "r": return "♜";
      case "q": return "♛";
      case "k": return "♚";
      default:  return "";
    }
  }

  function renderBoard(boardMatrix) {
    el.board.innerHTML = "";
    if (!boardMatrix) return;

    for (let rank = 0; rank < 8; rank++) {
      for (let file = 0; file < 8; file++) {
        const sq = document.createElement("div");
        sq.classList.add("square");
        const isLight = (rank + file) % 2 === 0;
        sq.classList.add(isLight ? "light" : "dark");
        sq.textContent = pieceChar(boardMatrix[rank][file]);
        el.board.appendChild(sq);
      }
    }
  }

  function renderGameInfo() {
    const g = state.game;
    const start = g.gamestart ? new Date(g.gamestart).toLocaleString() : "-";
    const end   = g.gameend   ? new Date(g.gameend).toLocaleString()   : "-";
    const st    = g.state || "-";

    el.gameInfo.textContent =
`Start:  ${start}
End:    ${end}
State:  ${st}`;
  }

  function renderMovesTable() {
    el.movesBody.innerHTML = "";
    state.moves.forEach((m, idx) => {
      const tr = document.createElement("tr");
      tr.dataset.index = idx;

      const moveNo = (m.plyno % 2 === 1 ? Math.ceil(m.plyno / 2) : "");
      const side   = (m.plyno % 2 === 1 ? "W" : "B");

      const flags = [];
      if (m.pieceCaptured && m.pieceCaptured !== "NONE") flags.push("x");
      if (m.promotion) flags.push("=Q");
      const flagHtml = flags.length ? `<span class="flag">${flags.join(" ")}</span>` : "";

      tr.innerHTML = `
        <td>${moveNo}</td>
        <td>${side}</td>
        <td>${m.uci}</td>
        <td>${flagHtml}</td>
      `;

      tr.addEventListener("click", () => showIndex(idx));
      el.movesBody.appendChild(tr);
    });
  }

  function updatePlyLabel() {
    if (state.index < 0) {
      el.plyLabel.textContent = "Initial position";
      return;
    }
    const m = state.moves[state.index];
    const side = (m.plyno % 2 === 1 ? "White" : "Black");
    el.plyLabel.textContent = `Ply ${m.plyno} (${side})`;
  }

  function highlightRows() {
    [...el.movesBody.children].forEach(tr => tr.classList.remove("active"));
    if (state.index >= 0 && state.index < state.moves.length) {
      const row = el.movesBody.querySelector(`tr[data-index="${state.index}"]`);
      if (row) row.classList.add("active");
    }
  }

  function showIndex(i) {
    if (!state.game) return;
    if (i < -1) i = -1;
    if (i >= state.moves.length) i = state.moves.length - 1;
    state.index = i;

    const boardIndex = i + 1; // boards[0] = start, boards[1] = after move 1, ...
    renderBoard(state.boards[boardIndex]);
    updatePlyLabel();
    highlightRows();
  }

  /* Loading games  */

  async function loadGame(id) {
    try {
      el.status.textContent = "Loading...";
      const game  = await fetchJson(`/games/${id}`);
      const moves = await fetchJson(`/moves/${id}`);

      const { boards, ordered } = buildBoardsFromMoves(moves || []);

      state.game   = game;
      state.moves  = ordered;
      state.boards = boards;
      state.index  = -1;

      renderGameInfo();
      renderMovesTable();
      showIndex(-1);   // show initial position

      el.status.textContent = `${state.moves.length} plies • ${game.state}`;
    } catch (err) {
      el.status.textContent = "Error: " + err.message;
    }
  }

  async function loadGameList() {
    try {
      const games = await fetchJson("/games");
      if (!games || !games.length) {
        el.gameSelect.innerHTML = "<option>(no games)</option>";
        el.status.textContent = "No games found";
        return;
      }

      el.gameSelect.innerHTML = games
        .map(g => `<option value="${g.id}">Game #${g.id} (${g.state})</option>`)
        .join("");

      await loadGame(games[0].id);
    } catch (err) {
      el.status.textContent = "Error loading games";
    }
  }

  /*  Buttons */

  el.gameSelect.addEventListener("change", () => loadGame(el.gameSelect.value));
  el.refreshBtn.addEventListener("click", () => loadGame(el.gameSelect.value));
  el.btnFirst.addEventListener("click", () => showIndex(-1));
  el.btnPrev.addEventListener("click", () => showIndex(state.index - 1));
  el.btnNext.addEventListener("click", () => showIndex(state.index + 1));
  el.btnLast.addEventListener("click", () => showIndex(state.moves.length - 1));


  loadGameList();
</script>

</body>
</html>
